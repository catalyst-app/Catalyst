<?php

namespace Catalyst;

use \Catalyst\Page\Values;
use \Catalyst\Secrets;

/**
 * Class which makes sending of email easy
 * 
 * @todo make a queue so loading doesn't take forever
 */
class Email {
	public const NO_REPLY_EMAIL = ["no-reply@catalystapp.co", "Catalyst No-Reply"];
	public const NO_REPLY_PASSWORD = Secrets::NO_REPLY_PASSWORD;

	// used for logging errors
	public const ERROR_LOG_EMAIL = ["error_logs@catalystapp.co", "Catalyst Error Logging"];
	public const ERROR_LOG_PASSWORD = Secrets::ERROR_LOG_PASSWORD;

	public const EMAIL_SMTP = ["catalystapp.co", 587, "tls"];

	/**
	 * Get e-mail CSS to go with a color, minified + simplified, not too much left in
	 * 
	 * @param string $color The hex color to use
	 * @return string CSS string
	 */
	public static function getCss(string $color=Values::DEFAULT_COLOR) : string {
		$str = "html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-webkit-box-sizing:border-box;box-sizing:border-box;}body{margin:0;}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block;}h1{font-size:2em;margin:0.67em 0;}*, *:before, *:after{-webkit-box-sizing:inherit;box-sizing:inherit;}ul:not(.browser-default){padding-left:0;list-style-type:none;}ul:not(.browser-default) > li{list-style-type:none;}.container{margin:0 auto;max-width:1280px;width:90%;}@media only screen and (min-width:601px){.container{width:85%;}}@media only screen and (min-width:993px){.container{width:70%;}}.container .row{margin-left:-0.75rem;margin-right:-0.75rem;}.section{padding-top:1rem;padding-bottom:1rem;}.section.no-pad{padding:0;}.section.no-pad-bot{padding-bottom:0;}.section.no-pad-top{padding-top:0;}.row{margin-left:auto;margin-right:auto;margin-bottom:20px;}.row:after{content:\"\";display:table;clear:both;}.row .col{float:left;-webkit-box-sizing:border-box;box-sizing:border-box;padding:0 0.75rem;min-height:1px;}.row .col[class*=\"push-\"], .row .col[class*=\"pull-\"]{position:relative;}.row .col.s1{width:8.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.s2{width:16.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.s3{width:25%;margin-left:auto;left:auto;right:auto;}.row .col.s4{width:33.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.s5{width:41.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.s6{width:50%;margin-left:auto;left:auto;right:auto;}.row .col.s7{width:58.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.s8{width:66.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.s9{width:75%;margin-left:auto;left:auto;right:auto;}.row .col.s10{width:83.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.s11{width:91.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.s12{width:100%;margin-left:auto;left:auto;right:auto;}.row .col.offset-s1{margin-left:8.3333333333%;}.row .col.pull-s1{right:8.3333333333%;}.row .col.push-s1{left:8.3333333333%;}.row .col.offset-s2{margin-left:16.6666666667%;}.row .col.pull-s2{right:16.6666666667%;}.row .col.push-s2{left:16.6666666667%;}.row .col.offset-s3{margin-left:25%;}.row .col.pull-s3{right:25%;}.row .col.push-s3{left:25%;}.row .col.offset-s4{margin-left:33.3333333333%;}.row .col.pull-s4{right:33.3333333333%;}.row .col.push-s4{left:33.3333333333%;}.row .col.offset-s5{margin-left:41.6666666667%;}.row .col.pull-s5{right:41.6666666667%;}.row .col.push-s5{left:41.6666666667%;}.row .col.offset-s6{margin-left:50%;}.row .col.pull-s6{right:50%;}.row .col.push-s6{left:50%;}.row .col.offset-s7{margin-left:58.3333333333%;}.row .col.pull-s7{right:58.3333333333%;}.row .col.push-s7{left:58.3333333333%;}.row .col.offset-s8{margin-left:66.6666666667%;}.row .col.pull-s8{right:66.6666666667%;}.row .col.push-s8{left:66.6666666667%;}.row .col.offset-s9{margin-left:75%;}.row .col.pull-s9{right:75%;}.row .col.push-s9{left:75%;}.row .col.offset-s10{margin-left:83.3333333333%;}.row .col.pull-s10{right:83.3333333333%;}.row .col.push-s10{left:83.3333333333%;}.row .col.offset-s11{margin-left:91.6666666667%;}.row .col.pull-s11{right:91.6666666667%;}.row .col.push-s11{left:91.6666666667%;}.row .col.offset-s12{margin-left:100%;}.row .col.pull-s12{right:100%;}.row .col.push-s12{left:100%;}@media only screen and (min-width:601px){.row .col.m1{width:8.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.m2{width:16.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.m3{width:25%;margin-left:auto;left:auto;right:auto;}.row .col.m4{width:33.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.m5{width:41.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.m6{width:50%;margin-left:auto;left:auto;right:auto;}.row .col.m7{width:58.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.m8{width:66.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.m9{width:75%;margin-left:auto;left:auto;right:auto;}.row .col.m10{width:83.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.m11{width:91.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.m12{width:100%;margin-left:auto;left:auto;right:auto;}.row .col.offset-m1{margin-left:8.3333333333%;}.row .col.pull-m1{right:8.3333333333%;}.row .col.push-m1{left:8.3333333333%;}.row .col.offset-m2{margin-left:16.6666666667%;}.row .col.pull-m2{right:16.6666666667%;}.row .col.push-m2{left:16.6666666667%;}.row .col.offset-m3{margin-left:25%;}.row .col.pull-m3{right:25%;}.row .col.push-m3{left:25%;}.row .col.offset-m4{margin-left:33.3333333333%;}.row .col.pull-m4{right:33.3333333333%;}.row .col.push-m4{left:33.3333333333%;}.row .col.offset-m5{margin-left:41.6666666667%;}.row .col.pull-m5{right:41.6666666667%;}.row .col.push-m5{left:41.6666666667%;}.row .col.offset-m6{margin-left:50%;}.row .col.pull-m6{right:50%;}.row .col.push-m6{left:50%;}.row .col.offset-m7{margin-left:58.3333333333%;}.row .col.pull-m7{right:58.3333333333%;}.row .col.push-m7{left:58.3333333333%;}.row .col.offset-m8{margin-left:66.6666666667%;}.row .col.pull-m8{right:66.6666666667%;}.row .col.push-m8{left:66.6666666667%;}.row .col.offset-m9{margin-left:75%;}.row .col.pull-m9{right:75%;}.row .col.push-m9{left:75%;}.row .col.offset-m10{margin-left:83.3333333333%;}.row .col.pull-m10{right:83.3333333333%;}.row .col.push-m10{left:83.3333333333%;}.row .col.offset-m11{margin-left:91.6666666667%;}.row .col.pull-m11{right:91.6666666667%;}.row .col.push-m11{left:91.6666666667%;}.row .col.offset-m12{margin-left:100%;}.row .col.pull-m12{right:100%;}.row .col.push-m12{left:100%;}}@media only screen and (min-width:993px){.hide-on-med-and-up{display:none;}.row .col.l1{width:8.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.l2{width:16.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.l3{width:25%;margin-left:auto;left:auto;right:auto;}.row .col.l4{width:33.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.l5{width:41.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.l6{width:50%;margin-left:auto;left:auto;right:auto;}.row .col.l7{width:58.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.l8{width:66.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.l9{width:75%;margin-left:auto;left:auto;right:auto;}.row .col.l10{width:83.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.l11{width:91.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.l12{width:100%;margin-left:auto;left:auto;right:auto;}.row .col.offset-l1{margin-left:8.3333333333%;}.row .col.pull-l1{right:8.3333333333%;}.row .col.push-l1{left:8.3333333333%;}.row .col.offset-l2{margin-left:16.6666666667%;}.row .col.pull-l2{right:16.6666666667%;}.row .col.push-l2{left:16.6666666667%;}.row .col.offset-l3{margin-left:25%;}.row .col.pull-l3{right:25%;}.row .col.push-l3{left:25%;}.row .col.offset-l4{margin-left:33.3333333333%;}.row .col.pull-l4{right:33.3333333333%;}.row .col.push-l4{left:33.3333333333%;}.row .col.offset-l5{margin-left:41.6666666667%;}.row .col.pull-l5{right:41.6666666667%;}.row .col.push-l5{left:41.6666666667%;}.row .col.offset-l6{margin-left:50%;}.row .col.pull-l6{right:50%;}.row .col.push-l6{left:50%;}.row .col.offset-l7{margin-left:58.3333333333%;}.row .col.pull-l7{right:58.3333333333%;}.row .col.push-l7{left:58.3333333333%;}.row .col.offset-l8{margin-left:66.6666666667%;}.row .col.pull-l8{right:66.6666666667%;}.row .col.push-l8{left:66.6666666667%;}.row .col.offset-l9{margin-left:75%;}.row .col.pull-l9{right:75%;}.row .col.push-l9{left:75%;}.row .col.offset-l10{margin-left:83.3333333333%;}.row .col.pull-l10{right:83.3333333333%;}.row .col.push-l10{left:83.3333333333%;}.row .col.offset-l11{margin-left:91.6666666667%;}.row .col.pull-l11{right:91.6666666667%;}.row .col.push-l11{left:91.6666666667%;}.row .col.offset-l12{margin-left:100%;}.row .col.pull-l12{right:100%;}.row .col.push-l12{left:100%;}}@media only screen and (min-width:1201px){.row .col.xl1{width:8.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.xl2{width:16.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.xl3{width:25%;margin-left:auto;left:auto;right:auto;}.row .col.xl4{width:33.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.xl5{width:41.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.xl6{width:50%;margin-left:auto;left:auto;right:auto;}.row .col.xl7{width:58.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.xl8{width:66.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.xl9{width:75%;margin-left:auto;left:auto;right:auto;}.row .col.xl10{width:83.3333333333%;margin-left:auto;left:auto;right:auto;}.row .col.xl11{width:91.6666666667%;margin-left:auto;left:auto;right:auto;}.row .col.xl12{width:100%;margin-left:auto;left:auto;right:auto;}.row .col.offset-xl1{margin-left:8.3333333333%;}.row .col.pull-xl1{right:8.3333333333%;}.row .col.push-xl1{left:8.3333333333%;}.row .col.offset-xl2{margin-left:16.6666666667%;}.row .col.pull-xl2{right:16.6666666667%;}.row .col.push-xl2{left:16.6666666667%;}.row .col.offset-xl3{margin-left:25%;}.row .col.pull-xl3{right:25%;}.row .col.push-xl3{left:25%;}.row .col.offset-xl4{margin-left:33.3333333333%;}.row .col.pull-xl4{right:33.3333333333%;}.row .col.push-xl4{left:33.3333333333%;}.row .col.offset-xl5{margin-left:41.6666666667%;}.row .col.pull-xl5{right:41.6666666667%;}.row .col.push-xl5{left:41.6666666667%;}.row .col.offset-xl6{margin-left:50%;}.row .col.pull-xl6{right:50%;}.row .col.push-xl6{left:50%;}.row .col.offset-xl7{margin-left:58.3333333333%;}.row .col.pull-xl7{right:58.3333333333%;}.row .col.push-xl7{left:58.3333333333%;}.row .col.offset-xl8{margin-left:66.6666666667%;}.row .col.pull-xl8{right:66.6666666667%;}.row .col.push-xl8{left:66.6666666667%;}.row .col.offset-xl9{margin-left:75%;}.row .col.pull-xl9{right:75%;}.row .col.push-xl9{left:75%;}.row .col.offset-xl10{margin-left:83.3333333333%;}.row .col.pull-xl10{right:83.3333333333%;}.row .col.push-xl10{left:83.3333333333%;}.row .col.offset-xl11{margin-left:91.6666666667%;}.row .col.pull-xl11{right:91.6666666667%;}.row .col.push-xl11{left:91.6666666667%;}.row .col.offset-xl12{margin-left:100%;}.row .col.pull-xl12{right:100%;}.row .col.push-xl12{left:100%;}}html{line-height:1.5;font-family:\"Roboto\", \"Helvetica\", \"Arial\", sans-serif;font-weight:normal;color:rgba(0, 0, 0, 0.87);}@media only screen and (min-width:0){html{font-size:14px;}}@media only screen and (min-width:992px){html{font-size:14.5px;}}@media only screen and (min-width:1200px){html{font-size:15px;}}h1, h2, h3, h4, h5, h6{font-weight:400;line-height:1.1;}h1 a, h2 a, h3 a, h4 a, h5 a, h6 a{font-weight:inherit;}h1{font-size:4.2rem;line-height:110%;margin:2.1rem 0 1.68rem 0;}h2{font-size:3.56rem;line-height:110%;margin:1.78rem 0 1.424rem 0;}h3{font-size:2.92rem;line-height:110%;margin:1.46rem 0 1.168rem 0;}h4{font-size:2.28rem;line-height:110%;margin:1.14rem 0 0.912rem 0;}h5{font-size:1.64rem;line-height:110%;margin:0.82rem 0 0.656rem 0;}h6{font-size:1rem;line-height:110%;margin:0.5rem 0 0.4rem 0;}em{font-style:italic;}strong{font-weight:500;}small{font-size:75%;}.light, .page-footer .footer-copyright{font-weight:300;}.thin{font-weight:200;}.flow-text{font-weight:300;}@media only screen and (max-width:600px){.hide-on-small-only{display:none;}}@media only screen and (min-width:360px){.flow-text{font-size:1.2rem;}}@media only screen and (min-width:390px){.flow-text{font-size:1.224rem;}}@media only screen and (min-width:420px){.flow-text{font-size:1.248rem;}}@media only screen and (min-width:450px){.flow-text{font-size:1.272rem;}}@media only screen and (min-width:480px){.flow-text{font-size:1.296rem;}}@media only screen and (min-width:510px){.flow-text{font-size:1.32rem;}}@media only screen and (min-width:540px){.flow-text{font-size:1.344rem;}}@media only screen and (min-width:570px){.flow-text{font-size:1.368rem;}}@media only screen and (min-width:600px){.flow-text{font-size:1.392rem;}}@media only screen and (min-width:630px){.flow-text{font-size:1.416rem;}}@media only screen and (min-width:660px){.flow-text{font-size:1.44rem;}}@media only screen and (min-width:690px){.flow-text{font-size:1.464rem;}}@media only screen and (min-width:720px){.flow-text{font-size:1.488rem;}}@media only screen and (min-width:750px){.flow-text{font-size:1.512rem;}}@media only screen and (min-width:780px){.flow-text{font-size:1.536rem;}}@media only screen and (min-width:810px){.flow-text{font-size:1.56rem;}}@media only screen and (min-width:840px){.flow-text{font-size:1.584rem;}}@media only screen and (min-width:870px){.flow-text{font-size:1.608rem;}}@media only screen and (min-width:900px){.flow-text{font-size:1.632rem;}}@media only screen and (min-width:930px){.flow-text{font-size:1.656rem;}}@media only screen and (min-width:960px){.flow-text{font-size:1.68rem;}}@media only screen and (max-width:360px){.flow-text{font-size:1.2rem;}}.btn, .btn-large,.btn-flat{border:none;border-radius:2px;display:inline-block;height:36px;line-height:36px;padding:0 2rem;text-transform:uppercase;vertical-align:middle;-webkit-tap-highlight-color:transparent;}.btn.disabled, .disabled.btn-large,.btn-floating.disabled,.btn-large.disabled,.btn-flat.disabled,.btn:disabled,.btn-large:disabled,.btn-floating:disabled,.btn-large:disabled,.btn-flat:disabled,.btn[disabled],[disabled].btn-large,.btn-floating[disabled],.btn-large[disabled],.btn-flat[disabled]{pointer-events:none;background-color:#DFDFDF !important;-webkit-box-shadow:none;box-shadow:none;color:#9F9F9F !important;cursor:default;}.btn.disabled:hover, .disabled.btn-large:hover,.btn-floating.disabled:hover,.btn-large.disabled:hover,.btn-flat.disabled:hover,.btn:disabled:hover,.btn-large:disabled:hover,.btn-floating:disabled:hover,.btn-large:disabled:hover,.btn-flat:disabled:hover,.btn[disabled]:hover,[disabled].btn-large:hover,.btn-floating[disabled]:hover,.btn-large[disabled]:hover,.btn-flat[disabled]:hover{background-color:#DFDFDF !important;color:#9F9F9F !important;}.btn, .btn-large,.btn-floating,.btn-large,.btn-flat{font-size:1rem;outline:0;}.btn i, .btn-large i,.btn-floating i,.btn-large i,.btn-flat i{font-size:1.3rem;line-height:inherit;}.btn:focus, .btn-large:focus,.btn-floating:focus{background-color:#1d7d74;}.btn, .btn-large{text-decoration:none;color:#fff;text-align:center;letter-spacing:.5px;-webkit-transition:.2s ease-out;transition:.2s ease-out;cursor:pointer;}.btn:hover, .btn-large:hover{background-color:#2bbbad;}.btn-floating{display:inline-block;color:#fff;position:relative;overflow:hidden;z-index:1;width:40px;height:40px;line-height:40px;padding:0;border-radius:50%;-webkit-transition:.3s;transition:.3s;cursor:pointer;vertical-align:middle;}.btn-floating:before{border-radius:0;}.btn-floating.btn-large{width:56px;height:56px;}.btn-floating.btn-large.halfway-fab{bottom:-28px;}.btn-floating.btn-large i{line-height:56px;}.btn-floating.halfway-fab{position:absolute;right:24px;bottom:-20px;}.btn-floating.halfway-fab.left{right:auto;left:24px;}.btn-floating i{width:inherit;display:inline-block;text-align:center;color:#fff;font-size:1.6rem;line-height:40px;}button.btn-floating{border:none;}.fixed-action-btn{position:fixed;right:23px;bottom:23px;padding-top:15px;margin-bottom:0;z-index:997;}.fixed-action-btn.active ul{visibility:visible;}.fixed-action-btn.horizontal{padding:0 0 0 15px;}.fixed-action-btn.horizontal ul{text-align:right;right:64px;top:50%;-webkit-transform:translateY(-50%);transform:translateY(-50%);height:100%;left:auto;width:500px;/*width 100% only goes to width of button container */}.fixed-action-btn.horizontal ul li{display:inline-block;margin:15px 15px 0 0;}.fixed-action-btn.toolbar{padding:0;height:56px;}.fixed-action-btn.toolbar.active > a i{opacity:0;}.fixed-action-btn.toolbar ul{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;top:0;bottom:0;z-index:1;}.fixed-action-btn.toolbar ul li{-webkit-box-flex:1;-webkit-flex:1;-ms-flex:1;flex:1;display:inline-block;margin:0;height:100%;-webkit-transition:none;transition:none;}.fixed-action-btn.toolbar ul li a{display:block;overflow:hidden;position:relative;width:100%;height:100%;background-color:transparent;-webkit-box-shadow:none;box-shadow:none;color:#fff;line-height:56px;z-index:1;}.fixed-action-btn.toolbar ul li a i{line-height:inherit;}.fixed-action-btn ul{left:0;right:0;text-align:center;position:absolute;bottom:64px;margin:0;visibility:hidden;}.fixed-action-btn ul li{margin-bottom:15px;}.fixed-action-btn ul a.btn-floating{opacity:0;}.fixed-action-btn .fab-backdrop{position:absolute;top:0;left:0;z-index:-1;width:40px;height:40px;border-radius:50%;-webkit-transform:scale(0);transform:scale(0);}.btn-flat{-webkit-box-shadow:none;box-shadow:none;background-color:transparent;color:#343434;cursor:pointer;-webkit-transition:background-color .2s;transition:background-color .2s;}.btn-flat:focus, .btn-flat:hover{-webkit-box-shadow:none;box-shadow:none;}.btn-flat:focus{background-color:rgba(0, 0, 0, 0.1);}.btn-flat.disabled{background-color:transparent !important;color:#b3b2b2 !important;cursor:default;}.btn-large{height:54px;line-height:54px;}.btn-large i{font-size:1.6rem;}.btn-block{display:block;}a{text-decoration:none;-webkit-tap-highlight-color:transparent;background-color:transparent;color:#".$color.";}.btn, .btn-large {background-color:#".$color.";}.btn:hover, .btn-large:hover {background-color:#".Color::lightenHexByPercent($color, 5).";}";
		return $str;
	}

	/**
	 * Send an e-mail
	 * 
	 * @param string[][] $recipients A 2D array of recipients, each being [name, email]
	 * @param string $subject Email subject
	 * @param string $message HTML message
	 * @param string $textMessage Message in text format for older clients/viewers
	 * @param array $email E-mail to send from, [username, name]
	 * @param string $pass Password for the email
	 * @param mixed[] $smtp STMP settings, [host,port,protocol]
	 */
	public static function sendEmail(array $recipients, string $subject, string $message, string $textMessage, array $email, string $pass, array $smtp=self::EMAIL_SMTP) : void {
		$mail = new \PHPMailer\PHPMailer\PHPMailer(false);
		$mail->SMTPDebug = 0;
		$mail->isSMTP();
		$mail->Host = $smtp[0];
		$mail->SMTPAuth = true;
		$mail->Username = $email[0];
		$mail->Password = $pass;
		$mail->SMTPSecure = $smtp[2];
		$mail->Port = $smtp[1];

		$mail->setFrom(...$email);
		foreach ($recipients as $to) {
			$mail->addAddress(...$to);
		}

		$mail->isHTML(true);
		$mail->Subject = $subject;
		$mail->Body = $message;
		$mail->AltBody = $textMessage;

		$mail->send();
	}
}
